// Generated by CoffeeScript 1.3.3
(function() {
  var App;

  window.App = App = {};

  App.message = 'Hello World!';

  App.response = '';

  App.waiting = false;

  App.initialize = function() {
    var _this = this;
    this.$message = $("input[name='message']");
    this.$output = $('.js-download-result');
    $('.js-send').on('click', function() {
      return _this.onSend();
    });
    return this.initFileUpload();
  };

  App.onSend = function() {
    var data,
      _this = this;
    if (this.waiting) {
      return false;
    }
    this.message = this.$message.val();
    if (!this.message.length) {
      return this.print("<p>Message can't be empty.</p>");
    }
    if (this.message.length > 140) {
      this.message = this.message.slice(0, 140);
    }
    data = JSON.stringify({
      message: this.message
    });
    return $.ajax({
      url: '/api/write/demo',
      type: 'POST',
      contentType: 'application/json',
      data: data,
      beforeSend: function() {
        _this.print("<p>Waiting for response...</p>");
        return _this.waiting = true;
      },
      success: function(data) {
        var output;
        output = "<p><a href='" + data.file_url + "'>Download file</a></p>";
        _this.print(output);
        return _this.waiting = false;
      }
    });
  };

  App.print = function(html) {
    this.$output.html(html);
    return this;
  };

  App.initFileUpload = function() {
    var $filedrop;
    $('#fileupload').fileupload({
      url: '/api/read/demo',
      dataType: 'json',
      dropZone: $('#filedrop'),
      add: function(e, data) {
        if (data.files[0].name.match(/\.xlsx$/)) {
          $('.js-upload-result').html("<p>Waiting for response...</p>");
          return data.submit();
        } else {
          return $('.js-upload-result').html("<p>Only accepts .xlsx files</p>");
        }
      },
      done: function(e, data) {
        return $('.js-upload-result').html("<p>Response: " + data.result.response + "</p>");
      }
    });
    $(document).bind('drop dragover', function(e) {
      return e.preventDefault();
    });
    this;

    $filedrop = $('#filedrop');
    $filedrop.on('dragover', function(e) {
      return $filedrop.addClass('hover');
    });
    $filedrop.on('dragleave', function(e) {
      return $filedrop.removeClass('hover');
    });
    return $filedrop.on('drop', function(e) {
      return $filedrop.removeClass('hover');
    });
  };

  $(function() {
    return App.initialize();
  });

}).call(this);
